import struct
import numpy as np
import os
from testSinglePatient import brag_peak_CS

class ReadCSDose():
    FloatSize = 4
    IntSize = 4
    def __init__(self,path):
        self.path = path        
        self.Get_Dose3D()
    
    def Get_Dose3D(self):
        path = self.path        
        if not os.path.isfile(path):  
            print 'Dose file: ' + path + 'not exits'
        f = open(path, 'rb')        
        shape = struct.unpack('3L',file.read(self.IntSize*3))        
        len = shape[0]*shape[1]*shape[2]
        tupleData = struct.unpack(str(len)+'f', file.read(self.FloatSize*len))
        data3D = np.array(tupleData).reshape(shape[2], shape[1],shape[0]) #change to depth,height,width (Tra:width = x, height = z)
        self.Data3D = data3D
        
    def Get_Dose2D_with_LayerIdx(self,layer_idx,BeamDirection): 
        data3D = self.Data3D        
        if BeamDirection.lower() == "width":
            data2D = data3D[0:data3D.shape[0],0:data3D.shape[1],layer_idx]# width direction            
        if BeamDirection.lower() == "height":
            data2D = data3D[0:data3D.shape[0],layer_idx,0:data3D.shape[2]]#height direction
        if BeamDirection.lower() != "width" and self.direction.lower() != "height":
            print "like this Gaussian(directory,grid,direction,plane), direction only support 'width' and height'"            
        np.squeeze(data2D)
        return data2D
    
    def Get_layCnt(self,BeamDirection):   #### TODO: only support two directions
        if BeamDirection.lower() == "width":            
            layer_cnt = self.Data3D.shape[2]
        if BeamDirection.lower() == "height":
            layer_cnt = self.Data3D.shape[1]           
        return layer_cnt
    
    def read_binaryFile(self):
        path = self.path
        
        if not os.path.isfile(path):  
            print 'Dose file: ' + path + 'not exits'
        f = open(path, 'rb')        
        shape = struct.unpack('3L',file.read(IntSize*3))        
        len = shape[0]*shape[1]*shape[2]
        tupleData = struct.unpack(str(len)+'f', file.read(FloatSize*len))
        data3D = np.array(tupleData).reshape(shape[2], shape[1],shape[0]) #change to depth,height,width (Tra:width = x, height = z)
        if self.BeamDirection.lower() == "width":
            data2D = data3D[0:shape[2],0:shape[1],int(self.Plane)]# width direction
            self._layer_cnt = shape[0]
        if self.BeamDirection.lower() == "height":
            data2D = data3D[0:shape[2],int(self.Plane),0:shape[0]]#height direction
            self._layer_cnt = shape[1]
        if self.direction.lower() != "width" and self.direction.lower() != "height":
            print "like this Gaussian(directory,grid,direction,plane), direction only support 'width' and height'"            
        np.squeeze(data2D)
        self.Data2D = data2D
        